#!/bin/bash

path="$HOME/img/wal/"
wpg="$HOME/.local/bin/wpg"
wpg() {
    if [[ -n $($wpg -l) ]]; then 
        for i in $($wpg -l); do
            $wpg -d $i    # to prevent errors
        done
    fi

    $wpg -a "$file" &>/dev/null && \
        $wpg -s "$($wpg -l)" &>/dev/null && \
        $wpg -d "$($wpg -l)"
}

if [ $# -lt 1 ];then
    file=`find $path -type f | grep -v "animevibe" | shuf -n 1`
else
    file=$1
    if [ ! -f "$file" ]; then
        echo -e "Usage : kwal path/to/image"
        exit 1
    fi
fi

if [[ -x "$(command -v $HOME/.local/bin/wal)" && -x "$(command -v $wpg)" ]]; then
    sleep 0.5 && feh --bg-scale $file

    # for when feh didn't had multihead support
    #&& -x "$(command -v convert)"  
    #if [[ $(xrandr | grep " connected " | awk '{ print$1 }') == eDP-1 ]]; then
    #    convert "$file" -resize 1920x1080 "$HOME/.kwal.tmp"
    #    wpg
    #elif [[ $(xrandr | grep " connected " | awk '{ print$1 }' | sed ':a;N;$!ba;s/\n/ /g') == "eDP-1 HDMI-1-0" ]]; then
    #    convert "$file" -resize 1920x1080 "$HOME/.kwal1.tmp"
    #    convert "$file" -resize 2560x1440 "$HOME/.kwal2.tmp"
    #    convert "$HOME/.kwal[1,2].tmp" +append "$HOME/.kwal.tmp" && rm $HOME/.kwal[1,2].tmp
    #    wpg
    #fi
    #feh --bg-scale "$HOME/.kwal.tmp"
    #rm $HOME/.kwal.tmp && 

    wpg
    
    $HOME/.local/bin/panes && $HOME/bin/dunstwal 2>/dev/null 

    if [[ -z $(pgrep qutebrowser) ]]; then
        qutebrowser --nowindow :config-source &>/dev/null & $HOME/.local/bin/p-qutebrowser
    fi

    if [[ -z $(pgrep polybar) ]]; then
        $HOME/.config/polybar/launch
    fi

    if [[ -z $(pgrep spotify) ]]; then
        spicetify apply &>/dev/null && pkill spotify
    else
        spicetify apply &>/dev/null && pkill spotify && i3-msg 'exec --no-startup-id spotify-adblock' >/dev/null
    fi 
    sleep 0.5 && i3-msg 'restart' >/dev/null
    exit
else
    echo -e "Error: Either wal or wpg not installed"
fi
