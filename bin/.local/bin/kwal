#!/bin/env bash
# if [[ -n $(pgrep -f ${BASH_SOURCE[0]} | grep -v $$) ]]; then
# kill -9 $(pgrep -f ${BASH_SOURCE[0]} | grep -v $$)2>/dev/null
# fi

if [[ -n $(pgrep wallengine) ]]; then
  killall -9 wallengine
fi

path="$HOME/img/wal/"
wpg="/usr/bin/wpg"
crontab -r 2>/dev/null

wpgset() {
  if [[ -x "$(command -v wal)" && -x "$(command -v $wpg)" ]]; then
    $wpg -s $file>/dev/null
  fi
}

wallengineset() {
  M0=eDP-1
  M1=HDMI-1-0
  MUTE="--silent"
  online=`cat /sys/class/power_supply/ADP0/online`
  assets="--assets-dir /usr/share/linux-wallpaperengine/assets"

  if [[ $3 == "-u" ]] || [[ $3 == "--unmute" ]]; then
    MUTE=""
  fi

  if [[ $online == 0 ]];then
    FPS="--fps 60"
  elif [[ $online == 1 ]]; then
    FPS="--fps 144"
  fi

  if [[ $(xrandr | grep " connected " | awk '{ print$1 }') == $M0 ]]; then
    SCREEN="--screen-root eDP-1"
  elif [[ $(xrandr | grep " connected " | awk '{ print$1 }' | sed ':a;N;$!ba;s/\n/ /g') == "$M0 $M1" ]]; then 
    SCREEN="--screen-root eDP-1 --screen-root HDMI-1-0"
  fi

    wallengine $assets $SCREEN $FPS $MUTE $HOME/img/wal/$arg >/dev/null 2>/dev/null & disown
}

if [[ $1 == "-h" ]] || [[ $1 == "--help" ]]; then
  echo "kwal is an utility to manage your wallpaper and colorscheme with wpg \
    [Options] \
    kwal -h -> for help \
    kwal ... -> for setting wallpaper \
    kwal -r -> to set latest used wallpaper \
    kwal -d -h -> for dwal help \
    kwal -d ... -> for setting dynamic wallpaper"
  exit 0
fi

if [[ $1 == "-r" ]]; then
  option=`awk '{print $1}' $HOME/.cache/kwal_current` 
  arg=`awk '{print $2}' $HOME/.cache/kwal_current`
else
  if [[ $# -gt 0 ]]; then
    option=$1
    arg=$2
  fi
fi

if [[ $option == "-d" ]] || [[ $option == "dwall" ]] && [[ -x "$(command -v dwall)" ]]; then
  if [ $arg == -h ] || [ $arg == --help ]; then
    dwall -h
    exit 0
  fi
  dwall -s $arg>/dev/null && (crontab -l 2>/dev/null; echo "0 * * * * env SHELL=/bin/zsh PATH=/home/kumao/.local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/opt/bin:/usr/lib/llvm/13/bin DISPLAY=:0.0 DBUS_SESSION_BUS_ADDRESS="unix:abstract=/tmp/dbus-mcNZtBEmYP,guid=ef019eb66962b2ba4b08e27b6273fd3e" XDG_RUNTIME_DIR=/run/user/1000 /home/kumao/.local/bin/kwal -d $arg") | crontab -
  file=`awk '{gsub("\047","");print $4}' $HOME/.fehbg`
  wpgset

elif [[ $option == "-a" ]]; then

  if [ $arg == -h ] || [ $arg == --help ]; then
    wallengine
    exit 0
  fi

  if [[ -n $(ls $HOME/img/wal/$arg/preview.jpg 2>/dev/null ) ]] || [[ -n $(ls $HOME/img/wal/$arg/preview.png 2>/dev/null ) ]]; then
    image=`ls $HOME/img/wal/$arg/preview.jpg`
    $wpg -a $image>/dev/null
    file=`echo $image | sed 's/.*[/]//'`
    wpgset
    $wpg -d $file>/dev/null
  else
    to_convert=`ls $HOME/img/wal/$arg/preview.gif`
    ffmpeg -i $to_convert -y -vsync 0 $HOME/.cache/kwal-cache.jpg 2>/dev/null
    image=`ls $HOME/.cache/kwal-cache.jpg`
    $wpg -a $image>/dev/null
    file=`echo $image | sed 's/.*[/]//'`
    wpgset
    $wpg -d $file>/dev/null
    rm $HOME/.cache/kwal-cache.jpg
  fi

  wallengineset

elif [ $# -lt 1 ]; then
  $wpg -m>/dev/null

elif [[ $($wpg -l  | grep $option) == "" ]]; then
  if [[ ! -f $option ]]; then
    echo -e "Usage: kwal path/to/image"
    exit 1
  fi
  $wpg -a $option>/dev/null
  file=`echo $option | sed 's/.*[/]//'`
  wpgset
  $wpg -d $file>/dev/null

else
  file=$option
  wpgset
fi

$HOME/.local/bin/panes && $HOME/.local/bin/dunstwal 2>/dev/null

if [[ -n $(pgrep qutebrowser) ]]; then
  qutebrowser :config-source &>/dev/null
fi

if [[ -z $(pgrep spotify) ]]; then
  spicetify apply &>/dev/null && pkill spotify
else
  spicetify apply &>/dev/null && pkill spotify && i3-msg 'exec --no-startup-id spotify-adblock' >/dev/null
fi

if [[ -n $(pgrep polybar) ]]; then
  $HOME/.local/bin/polyhide >/dev/null 2>/dev/null & disown
fi

kitty @ set-colors --all --configured $HOME/.config/kitty/kitty.conf

if [[ $1 != '-r' ]]; then
  if [[ $# -gt 0 ]]; then
    echo $option $arg > $HOME/.cache/kwal_current
  else
    sleep 1 && echo $(awk '{gsub("\047","");print $4}' $HOME/.fehbg | sed 's/\/home\/kumao\/.config\/wpg\/wallpapers\///g') > $HOME/.cache/kwal_current
  fi
fi

exit 0
