#!/bin/bash

wpg="$HOME/.local/bin/wpg"
wpg() {
    if [[ -n $($wpg -l) ]]; then 
        for i in $($wpg -l); do
            $wpg -d $i    # to prevent errors
        done
    fi

    $wpg -a "$file" &>/dev/null && \
        $wpg -s "$($wpg -l)" &>/dev/null && \
        $wpg -d "$($wpg -l)"
    feh --bg-scale "$HOME/.kwal.tmp"
}

if [ $# -lt 1 ];then
    file=`find $HOME/wal/ -type f | grep -v "animevibe" | shuf -n 1`
else
    file=$1
    if [ ! -f "$file" ]; then
        echo -e "Usage : kwal path/to/image"
        exit 1
    fi
fi

if [[ -x "$(command -v $HOME/.local/bin/wal)" && -x "$(command -v convert)"  && -x "$(command -v $wpg)" ]]; then
    if [[ $(xrandr | grep " connected " | awk '{ print$1 }') == eDP-1 ]]; then
        convert "$file" -resize 1920x1080 "$HOME/.kwal.tmp"
        wpg
    elif [[ $(xrandr | grep " connected " | awk '{ print$1 }' | sed ':a;N;$!ba;s/\n/ /g') == "eDP-1 HDMI-1-0" ]]; then
        convert "$file" -resize 1920x1080 "$HOME/.kwal1.tmp"
        convert "$file" -resize 2560x1440 "$HOME/.kwal2.tmp"
        convert "$HOME/.kwal[1,2].tmp" +append "$HOME/.kwal.tmp" && rm $HOME/.kwal[1,2].tmp
        wpg
    fi
    
    rm $HOME/.kwal*.tmp && $HOME/bin/panes && $HOME/bin/dunstwal 2>/dev/null && qutebrowser :config-source &>/dev/null

    if [[ -z $(pgrep polybar) ]]; then
        $HOME/.config/polybar/launch
    fi

    if [[ -z $(pgrep spotify) ]]; then
        $HOME/.local/bin/spicetify apply &>/dev/null && pkill spotify
    else
        $HOME/.local/bin/spicetify apply &>/dev/null && pkill spotify && i3-msg 'exec spotify' >/dev/null
    fi 
    exit 0
else
    echo -e "Error: Either wal, wpg or imagemagick not installed"
fi
